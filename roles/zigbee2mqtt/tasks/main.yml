- name: Create zigbee2mqtt config folder
  become: true
  file:
    path: "{{ zigbee2mqtt_data_dir }}"
    state: directory
    owner: "{{ zigbee2mqtt_user }}"
    group: "{{ zigbee2mqtt_user }}"

- name: Apply config
  become: true
  template:
    src: configuration.yaml.j2
    dest: "{{ zigbee2mqtt_data_dir }}/configuration.yaml"
  notify: Restart zigbee2mqtt

- name: Set permissions {{ zigbee2mqtt_device }}
  become: true
  ansible.builtin.file:
    path: "{{ zigbee2mqtt_device }}"
    state: file
    mode: '0777'

- name: Deploy Quadlet container file
  become: true
  template:
    src: zigbee2mqtt.container.j2
    dest: /etc/containers/systemd/zigbee2mqtt.container
  notify: Restart zigbee2mqtt

- name: Enable and start zigbee2mqtt systemd unit
  become: true
  systemd:
    daemon_reload: true
    name: zigbee2mqtt
    state: started
    enabled: true
