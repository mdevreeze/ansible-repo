- name: Create zigbee2mqtt config folder
  become: true
  file:
    path: "{{ zigbee2mqtt_data_dir }}"
    state: directory
    owner: "{{ zigbee2mqtt_user }}"
    group: "{{ zigbee2mqtt_user }}"

- name: Apply config
  become: true
  template:
    src: configuration.yaml.j2
    dest: "{{ zigbee2mqtt_data_dir }}/configuration.yaml"
  notify: Restart zigbee2mqtt

- name: Add container user to dialout group for device access
  become: true
  ansible.builtin.command:
    cmd: "usermod -a -G dialout {{ zigbee2mqtt_user }}"
  register: usermod_result
  changed_when: usermod_result.rc == 0
  failed_when: false

- name: Deploy Quadlet container file
  become: true
  template:
    src: zigbee2mqtt.container.j2
    dest: /etc/containers/systemd/zigbee2mqtt.container
  notify: Restart zigbee2mqtt

- name: Reload systemd daemon
  become: true
  ansible.builtin.systemd_service:
    daemon_reload: true

- name: Enable and start zigbee2mqtt systemd unit
  become: true
  ansible.builtin.systemd_service:
    name: zigbee2mqtt.service
    state: started
    enabled: true
